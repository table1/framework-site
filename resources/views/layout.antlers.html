<!doctype html>
<html lang="{{ site:short_locale }}" class="h-full antialiased" x-data x-bind:class="{ 'dark': $store.app.darkMode }">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>{{ title ?? 'Framework - Structured Data Science in R' }}</title>
        <meta name="description" content="{{ meta_description ?? 'Framework - A data management and project scaffolding system for reproducible data analysis workflows in R.' }}">

        <!-- Favicon -->
        <link rel="icon" type="image/svg+xml" href="/favicon.svg">
        <link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png">
        <link rel="shortcut icon" href="/favicon.ico">
        <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
        <link rel="manifest" href="/site.webmanifest">


        <!-- Prevent flash of wrong theme -->
        <script>
            if (localStorage.getItem('darkMode') === 'true' || (!localStorage.getItem('darkMode') && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            }
        </script>

        <!-- Alpine.js Store (must be before Alpine loads) -->
        <script>
            document.addEventListener('alpine:init', () => {
                Alpine.store('app', {
                    darkMode: localStorage.getItem('darkMode') === 'true' || (!localStorage.getItem('darkMode') && window.matchMedia('(prefers-color-scheme: dark)').matches),
                    searchOpen: false,
                    searchQuery: '',
                    searchResults: [],
                    searchGroups: [],
                    searchIndex: [],
                    docGuidesIndex: [],
                    selectedIndex: -1,

                    toggleDarkMode() {
                        this.darkMode = !this.darkMode;
                        localStorage.setItem('darkMode', this.darkMode);
                    },

                    async initSearch() {
                        try {
                            const response = await fetch('/search-index.json');
                            if (response.ok) {
                                const data = await response.json();
                                if (Array.isArray(data)) {
                                    this.searchIndex = data;
                                    this.docGuidesIndex = [];
                                } else {
                                    this.searchIndex = data.functions ?? [];
                                    this.docGuidesIndex = data.guides ?? [];
                                }
                            }
                        } catch (e) {
                            console.warn('Search index not available');
                        }
                    },

                    search() {
                        if (!this.searchQuery.trim()) {
                            this.searchResults = [];
                            this.searchGroups = [];
                            this.selectedIndex = -1;
                            return;
                        }
                        const query = this.searchQuery.toLowerCase();

                        const rankedResults = this.searchIndex
                            .map(item => {
                                const name = item.name?.toLowerCase() || '';
                                const title = item.title?.toLowerCase() || '';
                                const keywordsSource = item.keywords ?? '';
                                const keywords = Array.isArray(keywordsSource)
                                    ? keywordsSource.join(' ').toLowerCase()
                                    : (typeof keywordsSource === 'string' ? keywordsSource.toLowerCase() : '');
                                let rank = Infinity;

                                if (name) {
                                    if (name === query) {
                                        rank = 0;
                                    } else if (name.startsWith(query)) {
                                        rank = 1;
                                    } else if (name.includes(query)) {
                                        rank = 2;
                                    }
                                }

                                if (rank === Infinity && title.includes(query)) {
                                    rank = 3;
                                }

                                if (rank === Infinity && keywords.includes(query)) {
                                    rank = 4;
                                }

                                return { item, rank };
                            })
                            .filter(entry => entry.rank !== Infinity)
                            .sort((a, b) => {
                                if (a.rank !== b.rank) return a.rank - b.rank;
                                const aNameLength = a.item.name?.length ?? Number.MAX_SAFE_INTEGER;
                                const bNameLength = b.item.name?.length ?? Number.MAX_SAFE_INTEGER;
                                if (aNameLength !== bNameLength) return aNameLength - bNameLength;
                                return (a.item.name || '').localeCompare(b.item.name || '');
                            })
                            .map(entry => entry.item);

                        const common = rankedResults.filter(item => item.is_common);
                        const others = rankedResults.filter(item => !item.is_common);
                        const combined = [];
                        const maxResults = 12;

                        outer: for (const bucket of [common, others]) {
                            for (const item of bucket) {
                                combined.push(item);
                                if (combined.length >= maxResults) {
                                    break outer;
                                }
                            }
                        }

                        const docMatches = this.docGuidesIndex
                            .map(item => {
                                const title = item.title?.toLowerCase() || '';
                                const description = item.description?.toLowerCase() || '';
                                let rank = Infinity;

                                if (title) {
                                    if (title === query) {
                                        rank = 0;
                                    } else if (title.startsWith(query)) {
                                        rank = 1;
                                    } else if (title.includes(query)) {
                                        rank = 2;
                                    }
                                }

                                if (rank === Infinity && description.includes(query)) {
                                    rank = 3;
                                }

                                return { item, rank };
                            })
                            .filter(entry => entry.rank !== Infinity)
                            .sort((a, b) => {
                                if (a.rank !== b.rank) return a.rank - b.rank;
                                const aTitleLength = a.item.title?.length ?? Number.MAX_SAFE_INTEGER;
                                const bTitleLength = b.item.title?.length ?? Number.MAX_SAFE_INTEGER;
                                if (aTitleLength !== bTitleLength) return aTitleLength - bTitleLength;
                                return (a.item.title || '').localeCompare(b.item.title || '');
                            })
                            .map(entry => entry.item);

                        const docResults = docMatches.slice(0, 5);
                        const allResults = combined.concat(docResults);

                        this.searchResults = allResults;

                        const groupOrder = [];
                        const groupMap = new Map();
                        allResults.forEach((item, index) => {
                            const label = item.type === 'guide'
                                ? 'Guides'
                                : (item.is_common ? 'Common functions' : 'All functions');
                            if (!groupMap.has(label)) {
                                const group = { label, items: [] };
                                groupMap.set(label, group);
                                groupOrder.push(group);
                            }
                            groupMap.get(label).items.push({ ...item, flatIndex: index });
                        });

                        this.searchGroups = groupOrder;
                        this.selectedIndex = this.searchResults.length > 0 ? 0 : -1;
                    },

                    selectNext() {
                        if (this.searchResults.length === 0) return;
                        this.selectedIndex = (this.selectedIndex + 1) % this.searchResults.length;
                        this.scrollToSelected();
                    },

                    selectPrev() {
                        if (this.searchResults.length === 0) return;
                        this.selectedIndex = this.selectedIndex <= 0
                            ? this.searchResults.length - 1
                            : this.selectedIndex - 1;
                        this.scrollToSelected();
                    },

                    scrollToSelected() {
                        setTimeout(() => {
                            const el = document.querySelector(`[data-search-index="${this.selectedIndex}"]`);
                            el?.scrollIntoView({ block: 'nearest' });
                        }, 10);
                    },

                    goToSelected() {
                        if (this.selectedIndex >= 0 && this.searchResults[this.selectedIndex]) {
                            window.location.href = this.searchResults[this.selectedIndex].url;
                        }
                    },

                    openSearch() {
                        this.searchOpen = true;
                        this.searchQuery = '';
                        this.searchResults = [];
                        this.searchGroups = [];
                        this.selectedIndex = -1;
                        setTimeout(() => {
                            document.getElementById('search-input')?.focus();
                        }, 100);
                    },

                    closeSearch() {
                        this.searchOpen = false;
                        this.searchQuery = '';
                        this.searchResults = [];
                        this.searchGroups = [];
                        this.selectedIndex = -1;
                    }
                });

                // Initialize search index
                Alpine.store('app').initSearch();
            });
        </script>

        <!-- Alpine.js for interactive components -->
        <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
        <style>[x-cloak] { display: none !important; }</style>

        {{ vite src="resources/js/site.js|resources/css/site.css" }}
    </head>
    <body class="flex min-h-full bg-white dark:bg-slate-900" @keydown.window.meta.k.prevent="$store.app.openSearch()" @keydown.window.ctrl.k.prevent="$store.app.openSearch()" @keydown.escape.window="$store.app.closeSearch()">
        <div class="flex w-full flex-col">
            {{ partial:header }}
            {{ template_content }}
        </div>

        <!-- Search Modal -->
        <div x-show="$store.app.searchOpen" x-cloak class="fixed inset-0 z-50 overflow-y-auto" aria-labelledby="search-modal" role="dialog" aria-modal="true">
            <!-- Backdrop -->
            <div x-show="$store.app.searchOpen" x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100" x-transition:leave="ease-in duration-200" x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0" class="fixed inset-0 bg-slate-900/40" @click="$store.app.closeSearch()"></div>

            <!-- Modal -->
            <div class="relative flex min-h-full items-start justify-center p-4 pt-[13vh]">
                <div x-show="$store.app.searchOpen" x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0 scale-95" x-transition:enter-end="opacity-100 scale-100" x-transition:leave="ease-in duration-200" x-transition:leave-start="opacity-100 scale-100" x-transition:leave-end="opacity-0 scale-95" class="relative w-full max-w-3xl transform overflow-hidden rounded-2xl bg-white shadow-2xl dark:bg-slate-800">
                    <!-- Search input -->
                    <div class="border-b border-slate-200/80 px-5 pt-2 pb-2 dark:border-slate-700">
                        <div class="relative">
                            <svg class="pointer-events-none absolute left-3 top-1/2 h-5 w-5 -translate-y-1/2 text-slate-400 dark:text-slate-500" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 3.5a5.5 5.5 0 100 11 5.5 5.5 0 000-11zM2 9a7 7 0 1112.452 4.391l3.328 3.329a.75.75 0 11-1.06 1.06l-3.329-3.328A7 7 0 012 9z" clip-rule="evenodd" />
                            </svg>
                            <input id="search-input" x-model="$store.app.searchQuery" @input="$store.app.search()" @keydown.down.prevent="$store.app.selectNext()" @keydown.up.prevent="$store.app.selectPrev()" @keydown.enter.prevent="$store.app.goToSelected()" type="text" class="h-12 w-full rounded-xl border border-transparent bg-white/95 pl-10 pr-20 text-base text-slate-900 placeholder:text-slate-400 shadow-none focus:border-transparent focus:outline-none focus:ring-0 dark:bg-slate-900/70 dark:text-white dark:placeholder:text-slate-500" placeholder="Search functions...">
                            <div class="pointer-events-none absolute inset-y-0 right-4 hidden items-center gap-2 text-xs sm:flex">
                                <kbd class="rounded border border-slate-200 bg-slate-50 px-1.5 font-mono text-[11px] text-slate-400 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-500">&uarr;&darr;</kbd>
                                <kbd class="rounded border border-slate-200 bg-slate-50 px-1.5 font-mono text-[11px] text-slate-400 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-500">esc</kbd>
                            </div>
                        </div>
                    </div>

                    <!-- Results -->
                    <div x-show="$store.app.searchResults.length > 0" class="max-h-96 overflow-y-auto border-t border-slate-200 pt-3 dark:border-slate-700">
                        <div class="pb-2">
                            <template x-for="group in $store.app.searchGroups" :key="group.label">
                                <div class="pb-4 last:pb-0">
                                    <p class="px-6 pt-1 pb-3 text-xs font-semibold uppercase tracking-wide text-slate-400 dark:text-slate-500" x-text="group.label"></p>
                                    <ul>
                                        <template x-for="result in group.items" :key="result.url">
                                            <li :data-search-index="result.flatIndex">
                                                <a :href="result.url" class="block px-6 py-3 transition-colors" :class="$store.app.selectedIndex === result.flatIndex ? 'bg-sky-50 dark:bg-sky-900/30' : 'hover:bg-slate-50 dark:hover:bg-slate-700/50'" @click="$store.app.closeSearch()" @mouseenter="$store.app.selectedIndex = result.flatIndex">
                                                    <div class="flex items-start gap-3">
                                                        <div class="flex h-8 w-8 flex-none items-center justify-center rounded-lg" :class="$store.app.selectedIndex === result.flatIndex ? 'bg-sky-100 dark:bg-sky-800/50' : 'bg-slate-100 dark:bg-slate-700'">
                                                            <template x-if="result.type === 'guide'">
                                                                <svg class="h-4 w-4" :class="$store.app.selectedIndex === result.flatIndex ? 'text-sky-600 dark:text-sky-300' : 'text-slate-500 dark:text-slate-300'" viewBox="0 0 20 20" fill="currentColor">
                                                                    <path d="M4 4.5A1.5 1.5 0 015.5 3h7A1.5 1.5 0 0114 4.5V16a.5.5 0 01-.757.429L10 14.382l-3.243 2.047A.5.5 0 016 15.999V4.5zm1.5-.5a.5.5 0 00-.5.5v10.566l2.743-1.732a.5.5 0 01.514 0L11 15.066V4.5a.5.5 0 00-.5-.5h-5z" />
                                                                </svg>
                                                            </template>
                                                            <template x-if="result.type !== 'guide'">
                                                                <svg class="h-4 w-4" :class="$store.app.selectedIndex === result.flatIndex ? 'text-sky-600 dark:text-sky-400' : 'text-slate-500 dark:text-slate-400'" viewBox="0 0 20 20" fill="currentColor">
                                                                    <path fill-rule="evenodd" d="M4.25 2A2.25 2.25 0 002 4.25v11.5A2.25 2.25 0 004.25 18h11.5A2.25 2.25 0 0018 15.75V4.25A2.25 2.25 0 0015.75 2H4.25zm4.03 6.28a.75.75 0 00-1.06-1.06L4.97 9.47a.75.75 0 000 1.06l2.25 2.25a.75.75 0 001.06-1.06l-1.72-1.72 1.72-1.72zm3.44-1.06a.75.75 0 10-1.06 1.06l1.72 1.72-1.72 1.72a.75.75 0 101.06 1.06l2.25-2.25a.75.75 0 000-1.06l-2.25-2.25z" clip-rule="evenodd" />
                                                                </svg>
                                                            </template>
                                                        </div>
                                                        <div class="min-w-0 flex-auto">
                                                            <template x-if="result.type === 'guide'">
                                                                <p class="text-sm font-medium" :class="$store.app.selectedIndex === result.flatIndex ? 'text-sky-700 dark:text-sky-200' : 'text-slate-900 dark:text-white'" x-text="result.title"></p>
                                                            </template>
                                                            <template x-if="result.type !== 'guide'">
                                                                <p class="font-mono text-sm" :class="$store.app.selectedIndex === result.flatIndex ? 'text-sky-700 dark:text-sky-300' : 'text-slate-900 dark:text-white'">
                                                                    <span class="font-semibold" x-text="result.name"></span><span class="text-slate-500 dark:text-slate-400" x-text="result.signature_args || result.signature || '()'"></span>
                                                                </p>
                                                            </template>
                                                            <p class="mt-0.5 text-xs text-slate-500 dark:text-slate-400" x-show="result.description" x-text="result.description"></p>
                                                            <p class="mt-1 text-xs font-medium" :class="$store.app.selectedIndex === result.flatIndex ? 'text-sky-600/70 dark:text-sky-400/70' : 'text-slate-400 dark:text-slate-500'" x-text="result.type === 'guide' ? (result.section_label || 'Guide') : result.category"></p>
                                                        </div>
                                                    </div>
                                                </a>
                                            </li>
                                        </template>
                                    </ul>
                                </div>
                            </template>
                        </div>
                    </div>

                    <!-- Empty state -->
                    <div x-show="$store.app.searchQuery && $store.app.searchResults.length === 0" class="border-t border-slate-200 px-4 py-8 text-center dark:border-slate-700">
                        <svg class="mx-auto h-6 w-6 text-slate-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15.182 16.318A4.486 4.486 0 0012.016 15a4.486 4.486 0 00-3.198 1.318M21 12a9 9 0 11-18 0 9 9 0 0118 0zM9.75 9.75c0 .414-.168.75-.375.75S9 10.164 9 9.75 9.168 9 9.375 9s.375.336.375.75zm-.375 0h.008v.015h-.008V9.75zm5.625 0c0 .414-.168.75-.375.75s-.375-.336-.375-.75.168-.75.375-.75.375.336.375.75zm-.375 0h.008v.015h-.008V9.75z" />
                        </svg>
                        <p class="mt-2 text-sm text-slate-500 dark:text-slate-400">No results found for "<span x-text="$store.app.searchQuery"></span>"</p>
                    </div>

                    <!-- Initial state -->
                    <div x-show="!$store.app.searchQuery" class="border-t border-slate-200 px-4 py-8 text-center dark:border-slate-700">
                        <p class="text-sm text-slate-500 dark:text-slate-400">Type to search functions...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Shiki syntax highlighting with custom Framework theme -->
        <script type="module">
            import { codeToHtml } from 'https://esm.sh/shiki@1.0.0';

            // Custom theme matching landing page colors
            const frameworkTheme = {
                name: 'framework-dark',
                bg: '#10172A',
                fg: '#cbd5e1',
                settings: [
                    { scope: ['comment', 'punctuation.definition.comment'], settings: { foreground: '#64748b' } },
                    { scope: ['string', 'string.quoted'], settings: { foreground: '#6ee7b7' } },
                    { scope: ['constant.numeric', 'constant.language.boolean'], settings: { foreground: '#fcd34d' } },
                    { scope: ['constant.language'], settings: { foreground: '#fcd34d' } },
                    { scope: ['keyword', 'keyword.control', 'keyword.operator'], settings: { foreground: '#7dd3fc' } },
                    { scope: ['storage.type', 'support.type'], settings: { foreground: '#7dd3fc' } },
                    { scope: ['entity.name.function', 'support.function', 'meta.function-call'], settings: { foreground: '#7dd3fc' } },
                    { scope: ['variable.function'], settings: { foreground: '#7dd3fc' } },
                    { scope: ['variable', 'variable.other'], settings: { foreground: '#cbd5e1' } },
                    { scope: ['entity.name.namespace', 'support.class'], settings: { foreground: '#cbd5e1' } },
                    { scope: ['punctuation'], settings: { foreground: '#cbd5e1' } },
                    { scope: ['operator'], settings: { foreground: '#cbd5e1' } },
                ]
            };

            const codeBlocks = document.querySelectorAll('pre code[class*="language-"]');

            for (const el of codeBlocks) {
                const lang = el.className.match(/language-(\w+)/)?.[1] || 'text';
                const code = el.textContent;

                try {
                    const html = await codeToHtml(code, {
                        lang: lang,
                        theme: frameworkTheme
                    });

                    // Replace the pre element with shiki's output
                    const temp = document.createElement('div');
                    temp.innerHTML = html;
                    const shikiPre = temp.querySelector('pre');
                    if (shikiPre) {
                        shikiPre.className = el.parentElement.className;
                        shikiPre.style.background = '#10172A';
                        shikiPre.style.padding = '1rem';
                        shikiPre.style.borderRadius = '0.5rem';
                        el.parentElement.replaceWith(shikiPre);
                    }
                } catch (e) {
                    console.warn('Shiki failed for', lang, e);
                }
            }
        </script>
    </body>
</html>
